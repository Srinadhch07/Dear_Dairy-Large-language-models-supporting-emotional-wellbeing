{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mood Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.clouds.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
    <style>
        #vanta-bg {
      width: 100%;
      height: 100%;
      border: 2px solid black ;
    }
    </style>

</head>
<body class="bg-light" id="vanta-bg">
<div class="container mt-4">
    <h2 class="text-center mb-4 fw-bold text-primary">Mood Insights Dashboard</h2>
    <div class="text-center mb-3">
        <a href="{% url 'home' %}" class="btn btn-outline-dark">Home Page</a>
    </div>

    <form method="get" class="mb-4 text-center">
        <label for="filter" class="me-2 fw-bold">View by:</label>
        <select name="filter" id="filter" onchange="this.form.submit()" class="form-select w-auto d-inline-block">
            <option value="daily" {% if filter_type == "daily" %}selected{% endif %}>Daily</option>
            <option value="weekly" {% if filter_type == "weekly" %}selected{% endif %}>Weekly</option>
            <option value="monthly" {% if filter_type == "monthly" %}selected{% endif %}>Monthly</option>
        </select>
    </form>


    <div class="alert alert-info text-center shadow-sm">
        Most common mood ({{ filter_type }}): 
        <strong>{{ most_common.0 }}</strong> 
        ({{ most_common.1 }} entries)
    </div>

    <div class="row g-4">
        <div class="col-md-12">
            <div class="card shadow-sm p-3">
                <canvas id="lineChart" height="100"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <canvas id="barChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <canvas id="pieChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>
<script>
    VANTA.FOG({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00
    })
  </script>
<script>
    const chartData = JSON.parse('{{ chart_data|escapejs }}');
    const grouped = {};
    chartData.forEach(item => {
        if (!grouped[item.period]) grouped[item.period] = {};
        grouped[item.period][item.detected_emotion] = item.count;
    });

    const labels = Object.keys(grouped);
    const emotions = [...new Set(chartData.map(i => i.detected_emotion))];

    const colors = [
        "#007bff", "#28a745", "#ffc107", "#dc3545",
        "#6f42c1", "#20c997", "#fd7e14", "#17a2b8"
    ];

    const datasets = emotions.map((emotion, idx) => ({
        label: emotion,
        data: labels.map(period => grouped[period][emotion] || 0),
        borderColor: colors[idx % colors.length],
        backgroundColor: colors[idx % colors.length] + "99",
        borderWidth: 2,
        fill: false,
        tension: 0.3,
        pointRadius: 4,
        pointHoverRadius: 6
    }));

    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false },
            scales: {
                y: { beginAtZero: true, grid: { color: "#f0f0f0" } },
                x: { grid: { display: false } }
            }
        }
    });


    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: "#f0f0f0" } },
                x: { grid: { display: false } }
            }
        }
    });


    const totals = {};
    chartData.forEach(item => {
        totals[item.detected_emotion] = (totals[item.detected_emotion] || 0) + item.count;
    });

    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(totals),
            datasets: [{
                data: Object.values(totals),
                backgroundColor: colors
            }]
        },
        options: {
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
</script>
</body>
</html>
